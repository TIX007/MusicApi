name: build
on: 
  push: 
    branches: 
      - main # è¿™é‡Œè¡¨ç¤ºpushåˆ°mainåˆ†æ”¯å°±ä¼šè§¦å‘æµç¨‹
jobs:
  build-and-deploy:
    runs-on: ubuntu-20.04
    steps:
      # è¿™æ˜¯githubå®˜æ–¹çš„ä¸€ä¸ªactionï¼Œç”¨äºcloneè¯¥ä»“åº“çš„æºç åˆ°å·¥ä½œæµä¸­ï¼Œ
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      # åŒæ­¥serverç›®å½•ä¸‹çš„åç«¯ä»£ç åˆ°æœåŠ¡å™¨ï¼ˆç›®æ ‡è·¯å¾„ï¼š/home/nginx/myBlogServerï¼‰
      - name: Deploy
        uses: cross-the-world/scp-pipeline@master
        with:
          host: ${{ secrets.MY_HOST }} # æœåŠ¡å™¨IPï¼ˆéœ€è¦åœ¨GitHubä¸Šè‡ªè¡Œé…ç½®å¯¹åº”çš„secretï¼‰
          user: ${{ secrets.MY_USER }} # æœåŠ¡å™¨ç”¨æˆ·å
          pass: ${{ secrets.MY_PASS }} # æœåŠ¡å™¨å¯†ç 
          connect_timeout: 10s
          local: './*' # æºè·¯å¾„ï¼ˆå·¥ä½œæµï¼‰
          remote: /nodeApi/MusicApi # ç›®æ ‡è·¯å¾„ï¼ˆæœåŠ¡å™¨ï¼‰
      
      # åœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œç›¸å…³æŒ‡ä»¤
      - name: Executing remote ssh commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.MY_HOST }} # æœåŠ¡å™¨IPï¼ˆéœ€è¦åœ¨GitHubä¸Šè‡ªè¡Œé…ç½®å¯¹åº”çš„secretï¼‰
          username: ${{ secrets.MY_USER }} # æœåŠ¡å™¨ç”¨æˆ·å
          password: ${{ secrets.MY_PASS }} # æœåŠ¡å™¨å¯†ç 
          script: |
            cd /nodeApi/MusicApi # è¿›å…¥æœåŠ¡å™¨ä¸­çš„ç«¯å·¥ç¨‹æ‰€åœ¨çš„ç›®å½•
            export NODE_HOME=/root/.nvm/versions/node/v12.19.0  # å¯ä½¿ç”¨`whereis node`æŸ¥è¯¢nodeæ‰€åœ¨çš„ç›®å½•
            export PATH=$PATH:$NODE_HOME/bin # é‡æ–°å®šä¹‰nodeçš„ç¯å¢ƒå˜é‡ï¼ˆå¿…éœ€ï¼Œè¿™æ ·æ‰èƒ½åœ¨åç»­å·¥ä½œæµç¨‹ä¸­è¿è¡Œ npm install ç­‰æŒ‡ä»¤ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼‰
            npm install # å®‰è£…é¡¹ç›®ä¾èµ–
            pm2 delete MusicApi # åˆ é™¤æ—§çš„è¿›ç¨‹
            pm2 start --name MusicApi set PORT=4010 && node app.js # å¯åŠ¨æ–°çš„è¿›ç¨‹
